# 청첩장 CRUD API 구현 및 테스트 환경 구축

> 작성일: 2026-02-04
> 작업 시간: 약 2시간
> 난이도: ⭐⭐⭐ (중)

---

## 🎯 작업한 내용

### 1. Figma 스타일 편집기 설계
- 멀티 스텝 방식 → Figma 스타일 통합 편집기로 방향 전환
- 3-패널 레이아웃: 좌측 탭 메뉴 | 중앙 편집 폼 | 우측 실시간 미리보기
- 자동 저장(2초 debounce), 자유로운 편집 순서
- 문서: `docs/invitation-creation-plan.md` (1,116줄)

### 2. Beads 이슈 생성 (4개)
- **cuggu-ave** (P1): 청첩장 CRUD API 구현 ← 완료!
- **cuggu-qka** (P1): 청첩장 목록 페이지 (blocked by API)
- **cuggu-9t6** (P1): Figma 스타일 편집기 (blocked by API)
- **cuggu-kdl** (P1): 공개 청첩장 페이지 (blocked by API)

### 3. 청첩장 CRUD API 구현 (461줄)
```
app/api/invitations/
├── route.ts (140줄)
│   ├── POST /api/invitations - 생성
│   └── GET /api/invitations - 목록 (페이지네이션)
├── [id]/route.ts (247줄)
│   ├── GET - 단건 조회 (권한 체크)
│   ├── PUT - 수정 (부분 업데이트, 자동 저장용)
│   └── DELETE - 삭제 (soft delete)
└── [id]/verify/route.ts (74줄)
    └── POST - 비밀번호 검증 (쿠키 24시간)
```

**주요 기능:**
- nanoid 10자리 URL 생성 (`/inv/abc123def4`)
- 권한 체크 (본인 청첩장만 접근)
- 자동 만료일 설정 (결혼식 90일 후)
- bcrypt 비밀번호 해싱/검증
- Zod 스키마 검증
- 에러 핸들링 (401, 403, 404, 500)

### 4. Vitest 테스트 환경 구축
- vitest + @vitejs/plugin-react 설치
- `vitest.config.ts`, `vitest.setup.ts` 설정
- `__tests__/api/invitations.test.ts` (10개 테스트)
- **결과: ✅ 10/10 모두 통과**

**테스트 내용:**
- CreateInvitationSchema 검증 (6개)
  - 유효한 데이터 통과
  - 필수 필드 검증 (신랑/신부 이름, 예식장, 주소)
- UpdateInvitationSchema 검증 (4개)
  - 부분 업데이트 가능
  - 빈 객체 허용
  - 상태 enum 검증

---

## 💭 왜 했는지 (맥락)

### 설계 변경: 멀티 스텝 → Figma 스타일
**문제점:**
- 멀티 스텝은 수정할 때마다 단계 이동 필요
- 미리보기가 마지막 단계에만 가능
- 전체 파악 어려움

**해결:**
- Figma처럼 한 화면에 모든 것 표시
- 실시간 미리보기 (입력 즉시 반영)
- 자유로운 탭 이동

### API 우선 구현
- 편집기/목록/공개 페이지가 모두 API에 의존
- API 없이는 UI 테스트 불가
- 따라서 API부터 구현 → 3개 이슈 언블록

---

## 🤔 논의/아이디어/고민

### 1. 템플릿 선택 vs 편집기
**질문:** "생성 마법사" 작업이 뭐야?

**답변:**
- `cuggu-ave` = 백엔드 API (POST/GET/PUT/DELETE)
- `cuggu-9t6` = 프론트엔드 편집기 (UI)
- API가 먼저 필요하므로 API부터 구현

### 2. 테스트 방법 고민
**시도 1:** 수동 테스트 스크립트 (`scripts/test-invitation-api.ts`)
- 문제: 브라우저 세션 쿠키 못 가져옴

**시도 2:** vitest로 스키마 검증 테스트
- 성공! 10/10 통과
- 유닛 테스트로 스키마 검증 충분

### 3. DB 스키마 평탄화
**문제:** `CreateInvitationSchema`는 중첩 구조
```ts
{
  groom: { name, fatherName, ... },
  bride: { name, fatherName, ... },
  wedding: { date, venue: { ... } }
}
```

**해결:** API에서 DB 저장 시 평탄화
```ts
{
  groomName: data.groom.name,
  brideName: data.bride.name,
  weddingDate: new Date(data.wedding.date),
  venueName: data.wedding.venue.name,
  ...
}
```

---

## ✅ 결정된 내용

### 1. API 설계
- **URL 형식:** nanoid 10자리 (`/inv/abc123def4`)
- **Soft delete:** status='DELETED' (물리 삭제 안 함)
- **권한 체크:** 본인 청첩장만 접근 (403 Forbidden)
- **자동 만료:** 결혼식 90일 후
- **부분 업데이트:** PUT은 전달된 필드만 업데이트

### 2. 테스트 전략
- **Phase 1:** 스키마 검증 (vitest) ← 완료
- **Phase 2:** API 통합 테스트 (나중에)
- **Phase 3:** E2E 테스트 (Playwright, 나중에)

### 3. 파일 구조
```
app/api/invitations/
├── route.ts (POST, GET 목록)
└── [id]/
    ├── route.ts (GET, PUT, DELETE)
    └── verify/route.ts (POST 비밀번호 검증)
```

---

## 🎓 느낀 점 / 난이도 / 발견

### 난이도: ⭐⭐⭐ (중)
- Next.js 16 async params 패턴 익숙해짐
- Drizzle ORM 쿼리 작성 수월
- Zod 스키마 검증 강력함

### 발견한 것
1. **Next.js 16 params는 Promise**
   ```ts
   const { id } = await params; // 필수!
   ```

2. **Drizzle ORM 부분 업데이트**
   ```ts
   const updateData: any = { updatedAt: new Date() };
   if (data.groom?.name !== undefined) {
     updateData.groomName = data.groom.name;
   }
   ```

3. **bcrypt는 이미 설치되어 있음**
   - npm 실패했지만 pnpm으로 확인
   - 타입 정의도 bcryptjs 자체에 포함

4. **vitest 설정 간단함**
   - React 컴포넌트 테스트도 지원
   - path alias (`@/`) 바로 동작

### 좋았던 점
- API 한 번에 6개 엔드포인트 구현 (집중력 좋음)
- 테스트 바로 작성해서 검증 (TDD 스타일)
- Beads로 의존성 관리 명확

### 아쉬운 점
- 실제 API 통합 테스트는 안 함 (서버 실행 필요)
- 에러 메시지 한글화 안 함 (나중에)

---

## 📌 남은 것 / 미정

### API 관련
- [ ] 비밀번호 설정 API (`PATCH /api/invitations/[id]/password`)
- [ ] 공개 설정 API (`PATCH /api/invitations/[id]/publish`)
- [ ] 갤러리 이미지 업로드 (Phase 2)
- [ ] 계좌 정보 저장 (DB 컬럼 추가 필요)

### 테스트 관련
- [ ] API 통합 테스트 (실제 서버 호출)
- [ ] E2E 테스트 (Playwright)
- [ ] 성능 테스트 (페이지네이션 대량 데이터)

### 문서 관련
- [ ] API 문서 자동 생성 (Swagger?)
- [ ] Postman Collection

---

## 🚀 다음 액션

### 즉시 (이번 세션)
1. [ ] main에 머지
2. [ ] 다음 이슈 선택
   - **cuggu-qka** (목록 페이지) - 간단, 빠름
   - **cuggu-9t6** (편집기) - 복잡, 시간 걸림
   - **cuggu-kdl** (공개 페이지) - 중간

### 다음 세션
1. [ ] 청첩장 목록 페이지 구현 (cuggu-qka)
2. [ ] 공개 청첩장 페이지 구현 (cuggu-kdl)
3. [ ] Figma 스타일 편집기 구현 (cuggu-9t6) ← 가장 중요!

### Phase 2 (나중에)
- [ ] RSVP 기능
- [ ] 결제 시스템
- [ ] AI 사진 생성 연동
- [ ] 나머지 템플릿 (Modern, Vintage, Floral, Minimal)

---

## 🗂️ 서랍 메모

### 기술 부채
- DB 스키마와 Zod 스키마 불일치
  - DB는 평탄화 (groomName, brideName)
  - Zod는 중첩 (groom.name, bride.name)
  - 변환 로직이 API에 분산되어 있음
  - 해결: helper 함수로 중앙화?

### 아이디어
- API 응답 캐싱 (Redis)
- 청첩장 템플릿 변경 시 미리보기
- 버전 관리 (수정 이력)

### 참고 자료
- Next.js 16 API Routes: https://nextjs.org/docs/app/building-your-application/routing/route-handlers
- Drizzle ORM: https://orm.drizzle.team/
- Vitest: https://vitest.dev/

---

## 📊 내 질문 평가 및 피드백

### 좋았던 질문
1. **"이거 작업이 청첩장 만들기 마법사? 작업 시작 맞지?"**
   - 명확한 확인, API vs UI 구분 확실히 함
   - 평가: ⭐⭐⭐⭐⭐

2. **"test code 만들어서 테스트 해보자"**
   - 테스트 문화 좋음, 품질 관리
   - 평가: ⭐⭐⭐⭐⭐

3. **"vitest같은거 쓰면 되지 않아?"**
   - 적절한 도구 선택, 빠른 의사결정
   - 평가: ⭐⭐⭐⭐⭐

4. **"브런치 이동하고 작업 해야지"**
   - 워크플로우 중시, Git 관리 잘함
   - 평가: ⭐⭐⭐⭐⭐

### 개선할 질문
1. **"일단 커밋하고 정리하자"**
   - 좋은 습관이지만, 커밋 메시지 미리 생각하면 더 좋음
   - 개선: "커밋 메시지는 XXX로 하자" 먼저 정하기

### 커뮤니케이션 스타일
- **반말 사용:** 편하고 빠른 소통 ✅
- **핵심만 말함:** 불필요한 설명 없음 ✅
- **명확한 확인:** 헷갈리면 바로 물어봄 ✅
- **실수 인정:** "이놈아" 같은 표현으로 가볍게 넘김 ✅

### 전체 평가: ⭐⭐⭐⭐⭐
- 빠른 의사결정
- 명확한 커뮤니케이션
- 테스트 문화
- Git 워크플로우 준수

---

## 📈 통계

**작성 코드:**
- API: 461줄
- 테스트: 213줄
- 문서: 1,116줄
- 총: 1,790줄

**테스트:**
- 10/10 통과 (100%)

**커밋:**
- 2개 커밋
- 브랜치: `feature/invitation-api`

**Beads 이슈:**
- 완료: 1개 (cuggu-ave)
- 언블록: 3개
- 생성: 4개

**작업 시간:**
- 설계: 30분
- API 구현: 1시간
- 테스트: 30분
- 총: 약 2시간
