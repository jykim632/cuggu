# 2026-02-19 작업일지

## 2/15 데일리 플랜 대비 진행 상황

2/15 플랜은 **크레딧/앨범/갤러리 안정화 + DB 마이그레이션**이 목표였다.
2/15~19 동안 커밋 8개, 75개 파일 변경 (+2299/-1745).

### 0단계: DB 마이그레이션 — 완료

| # | 작업 | 상태 |
|---|------|------|
| 0-1 | 마이그레이션 실행 (0010~0012) | **완료** |
| 0-2 | 실행 후 검증 | **완료** |

### 1단계: 크레딧 버그 수정 — 전부 완료

| # | 작업 | Beads | 상태 |
|---|------|-------|------|
| 1-1 | 배치 Job 미사용 크레딧 자동 환불 | `cuggu-9c0` closed | **완료** — stream route + stale-jobs cron 양쪽에서 자동 환불 |
| 1-2 | 크레딧 실시간 UI 반영 | `cuggu-c7n` closed | **완료** — SSE done에 remainingCredits + onCreditsChange 콜백 |
| 1-3 | 웰컴 보너스 트랜잭션 기록 | `cuggu-41x` closed | **완료** — 커밋 `0aeedad` |

### 2단계: 갤러리-앨범 플로우 — 전부 완료

| # | 작업 | Beads | 상태 |
|---|------|-------|------|
| 2-1 | 갤러리-앨범 플로우 재설계 | `cuggu-r82` closed | **완료** — AddPhotosModal 통합 모달 구현 |
| 2-2 | GalleryTab AI 섹션 → CTA 교체 | `cuggu-6h7` closed | **완료** — 4개 파일 삭제, 커밋 `5b4e550` |

### 3단계: AI 앨범 v2 안정화 — 전부 완료

| # | 작업 | Beads | 상태 |
|---|------|-------|------|
| 3-1 | 앨범 v2 상태 점검 | `cuggu-3ff` closed | **완료** — 5건 버그 발견 |
| 3-2 | 발견된 이슈 처리 (5건) | `cuggu-3ff` closed | **완료** — 커밋 `c10fceb` |

**발견 & 수정한 5건:**
1. [HIGH] 자동 큐레이션 PUT fire-and-forget → 실패 시 롤백 + toast
2. [MEDIUM] 앨범 이름 저장 res.ok 미체크 → 에러 처리 추가
3. [MEDIUM] 참조 사진 없이 앨범 생성 가능 → 버튼 비활성화
4. [MEDIUM] albumId 소유권 검증 없음 → 쿼리 + null fallback
5. [LOW] Job 완료 race condition → WHERE status='PROCESSING' 추가

### 4단계 (시간 되면) — 코드 구현 완료, 외부 연동 미완

| # | 작업 | 상태 |
|---|------|------|
| 4-1 | 스마트스토어 셀러 등록 | **미완** — 사업자등록/통신판매업 신고/셀러 가입 필요 |
| 4-2 | Commerce API 클라이언트 | **코드 완료** — `lib/payments/smartstore.ts` |
| 4-3 | 활성화 API + 페이지 | **코드 완료** — `/activate` + `/api/payments/activate-smartstore` |

#### 구현된 코드 (커밋 `5356df6`)

| 파일 | 내용 |
|------|------|
| `db/schema.ts` | `channel`(SITE/SMARTSTORE), `smartstoreOrderId` 컬럼, `NAVER_PAY` enum 추가 |
| `db/migrations/0013_smartstore_payment.sql` | 마이그레이션 SQL (미실행) |
| `lib/payments/smartstore.ts` | Commerce API OAuth 토큰 발급, 주문 검증(`verifyOrder`), 발송 처리(`dispatchOrder`) |
| `lib/payments/grant.ts` | 결제 보상 지급 — atomic 트랜잭션 (payments INSERT + credits UPDATE + 거래 이력) |
| `app/api/payments/activate-smartstore/route.ts` | 활성화 API (인증→rate limit→입력검증→주문검증→금액검증→보상지급→발송처리) |
| `app/activate/page.tsx` | 프론트엔드 — 로그인 유도→주문번호 입력→활성화 결과 표시 |
| `schemas/payment.ts` | `ActivateSmartStoreRequestSchema`, `PaymentChannelSchema` 추가 |
| `PaymentsTab.tsx`, `PaymentTable.tsx` | UI에 스마트스토어 뱃지 + 네이버페이 라벨 표시 |
| `docs/smartstore-setup-guide.md` | 외부 설정 단계별 가이드 + 체크리스트 |

#### 연동까지 남은 외부 작업

```
[ ] 사업자등록증 발급 (홈택스, 1~3영업일)
[ ] 통신판매업 신고 (정부24, 2~3영업일)
[ ] 스마트스토어 셀러 가입 + 심사 승인 (1~3영업일)
[ ] 상품 3개 등록 — 판매자 상품코드 정확히 입력 필수
    [ ] PREMIUM_UPGRADE (9,900원)
    [ ] AI_CREDITS (1,000원)
    [ ] AI_CREDITS_BUNDLE (8,000원)
[ ] Commerce API 센터 애플리케이션 등록 → client_id/secret 발급
[ ] API 호출 IP 등록 (Vercel 고정 IP 방안 필요)
[ ] .env + Vercel 환경 변수 설정
[ ] DB 마이그레이션 0013 실행
[ ] E2E 테스트 (테스트 구매 → 활성화 → 크레딧 확인 → 중복 방지)
```

> 코드는 전부 동작 준비 완료 상태. 스마트스토어 셀러 가입~상품 등록~API 키 발급까지 외부 프로세스(예상 7~14일)만 남음.

---

## 오늘 (2/19) 세션 작업 내역

| 시간 | 작업 | 커밋/결과 |
|------|------|-----------|
| 세션1 | AI 앨범 v2 안정화 5건 수정 | `c10fceb` |
| | beads 정리 — 6건 close | open 51→46, closed 116→122 |
| | 작업일지 작성 | 이 문서 |
| 세션2 | AI 생성 실패 시 슬롯 상태 + 크레딧 갱신 버그 수정 | `eb07a15` |
| | — failedIndices 추적 → 실패 슬롯에 빨간 실패 표시 | |
| | — 배치 완료 후 크레딧 서버 재조회 (사이드바+앨범 동기화) | |
| | — BatchGenerationView 슬롯 매핑을 currentIndex 기반으로 교체 | |
| | — FloatingBar에 failedCount 반영 (amber 색상 + 실패 카운트) | |
| | — ApplyToInvitationModal paginated 응답 파싱 버그 수정 | |
| | 브랜드 로고 적용 — SVG lockup/mark + 파비콘 | `a3714f9` |
| | 스마트스토어 결제 연동 — schema, 활성화 API, 결제 내역 | `5356df6` |
| | AI 앨범 UX 다듬기 — 큐레이션 삭제 확인, 참조 사진 레이아웃, apply 50장 | `f560a89` |

### beads 정리 내역

| 이슈 | 제목 | 사유 |
|------|------|------|
| `cuggu-3ff` P0 | AI 앨범 v2 | 전부 구현 + 안정화 완료 |
| `cuggu-ch7` P3 | DashboardNav 네이밍 | 이미 "AI 포토 스튜디오"로 변경됨 |
| `cuggu-ass` P2 | 갤러리 S3 업로드 | `/api/upload/gallery` 구현 완료 |
| `cuggu-4i0` P2 | AI→갤러리 추가 | AddPhotosModal로 구현됨 |
| `cuggu-8lb` P4 | 소셜 로그인 확장 | `cuggu-9ew`(네이버)과 중복 |
| `cuggu-6c2` P0 | Figma 디자인 | 6개 템플릿 코드 구현 완료 |

---

## 프로젝트 현황

| 지표 | 값 |
|------|---|
| 전체 이슈 | 168 |
| Open | 46 |
| In Progress | 0 |
| Closed | 122 (72.6%) |
| Blocked | 7 |
| Ready to Work | 39 |

### P0 open: 0건 (처음!)

P0이 전부 닫혔다. `cuggu-3ff`(앨범 v2)가 마지막이었고 오늘 close.

### P1 open: 8건

| 이슈 | 제목 | 비고 |
|------|------|------|
| `cuggu-gval` | Sentry 에러 트래킹 | 인프라 |
| `cuggu-ae6`~`cuggu-03e` | 결제 Phase 1 (5건) | 체인 의존, PortOne→스마트스토어 방향 전환 보류 중 |
| `cuggu-s2k` | 방명록 | 신규 기능 |
| `cuggu-9xi` | NextAuth sessions 분리 | Supabase 충돌 |

---

## 2/15 플랜 총평

**1~3단계 전부 완료. 4단계(스마트스토어) 코드 구현 완료, 외부 연동 대기.**

2/15 시점에서 "어제 못 한 것들"이라고 했던 크레딧 버그 3건, 갤러리-앨범 플로우 2건, 앨범 v2 안정화 전부 해결됨. 추가로:
- 커플사진 기본 모드 전환 + Replicate 제거 (`b43f53c`)
- route group 마이그레이션 (`b43f53c`)
- 설정 탭 컴포넌트 분리 + stale jobs cron (`1581a22`)
- TypeScript 타입 에러 25건 수정 (`1733cc9`)
- AI 생성 완료 toast 알림 (`90ab50f`)

---

## 세션2 추가 성과

- 브랜드 로고 SVG 에셋 전체 적용 (Header, DashboardNav, TopBar, 파비콘)
- AI 생성 실패 핸들링 전면 개선 (슬롯 상태, 크레딧 동기화, FloatingBar 피드백)
- 스마트스토어 결제 코드 전체 구현 (schema + migration + Commerce API 클라이언트 + 활성화 API/페이지 + 보상 지급 트랜잭션 + 설정 가이드). 외부 설정(셀러 가입, 상품 등록, API 키 발급)만 남음.
- AI 앨범 UX 소폭 개선 (큐레이션 삭제 확인, apply 50장 제한)
