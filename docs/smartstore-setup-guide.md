# 스마트스토어 결제 연동 설정 가이드

> **목적**: Cuggu 서비스의 스마트스토어 판매 채널을 개설하고, Commerce API를 연동하여 `/activate` 자동 활성화 플로우를 완성하기 위한 단계별 가이드
>
> **예상 소요**: 총 7~14일 (사업자등록 제외 시 3~5일)
>
> **관련 코드**: `lib/payments/smartstore.ts`, `app/api/payments/activate-smartstore/route.ts`, `app/activate/page.tsx`

---

## 전체 흐름

```
사업자등록 → 통신판매업 신고 → 스마트스토어 개설 → 상품 등록 → Commerce API 발급 → .env 설정 → 테스트
```

---

## 1단계: 사업자등록 (이미 있으면 건너뛰기)

### 홈택스 온라인 신청

1. [홈택스](https://www.hometax.go.kr) 접속 → 로그인
2. **국세증명·사업자등록·세금관련 신청/신고** → **사업자등록 신청(개인)**
3. 필수 입력 항목:

| 항목 | 입력값 |
|------|--------|
| 업태 | 정보통신업 |
| 종목 | 소프트웨어 개발 및 공급업 / 응용소프트웨어 개발 및 공급업 |
| 업종코드 | 722000 |
| 사업장 소재지 | 자택 가능 |
| 과세유형 | 간이과세자 (연 매출 1억 400만원 이하) |

4. 신청 후 **1~3영업일** 내 사업자등록증 발급

> **팁**: 디지털 콘텐츠 판매이므로 업태/종목을 "정보통신업 / 소프트웨어"로 하면 무난함. 필요에 따라 "도소매업 / 전자상거래업(525101)"을 추가 업종으로 등록해도 됨.

---

## 2단계: 통신판매업 신고

스마트스토어 판매에 **필수**. 신고 없이도 스토어 개설은 가능하지만, 미신고 시 행정 제재 대상.

### 온라인 신고 (정부24)

1. [정부24](https://www.gov.kr) 접속 → "통신판매업 신고" 검색
2. **통신판매업 신고** 클릭 → **신청하기**
3. 필요 서류:
   - 사업자등록증 사본
   - **구매안전서비스 이용확인증** (네이버에서 발급 — 아래 참고)
4. 신고 완료 후 **2~3영업일** 내 통신판매업 신고번호 발급

### 구매안전서비스 이용확인증 발급

스마트스토어 가입 시 네이버가 제공하는 에스크로 서비스를 통해 확인증을 발급받을 수 있음:
- 스마트스토어 판매자센터 → **판매자 정보** → **구매안전서비스 이용확인증 발급**

> **순서 주의**: 스마트스토어 가입(3단계) → 확인증 발급 → 통신판매업 신고 순서가 효율적. 통신판매업 신고번호를 나중에 스마트스토어에 등록하면 됨.

---

## 3단계: 스마트스토어 셀러 가입

### 판매자센터 가입

1. [스마트스토어 판매자센터](https://sell.smartstore.naver.com) 접속
2. **판매자 가입하기** 클릭
3. 회원 유형: **사업자** 선택
4. 정보 입력:

| 항목 | 입력값 |
|------|--------|
| 스토어 이름 | `Cuggu - AI 모바일 청첩장` (또는 원하는 이름) |
| 스토어 URL | `smartstore.naver.com/cuggu` |
| 소개글 | AI로 만드는 특별한 모바일 청첩장 |
| 대표 카테고리 | 생활/건강 > 문구/사무 > 카드/초대장 (또는 디지털/가전 > 소프트웨어) |
| 고객센터 전화번호 | 본인 연락처 |

5. 서류 업로드:
   - 사업자등록증 사본 (최근 1년 이내)
   - 대표자 명의 통장 사본 (정산 입금용)

6. **심사 승인**: 보통 **1~3영업일** (빠르면 당일)

---

## 4단계: 상품 등록

### 등록할 상품 3개

판매자센터 → **상품관리** → **상품등록**에서 아래 3개 상품을 등록.

#### 상품 1: 프리미엄 플랜

| 항목 | 값 |
|------|-----|
| 상품명 | `[Cuggu] 프리미엄 플랜 - AI 모바일 청첩장` |
| 판매가 | **9,900원** |
| **판매자 상품코드** | **`PREMIUM_UPGRADE`** |
| 카테고리 | 디지털/가전 > 소프트웨어 > 유틸리티 |
| 재고 | 99999 (무한 재고) |
| 배송 | **배송 없음** (디지털 상품) |

#### 상품 2: AI 크레딧 1회

| 항목 | 값 |
|------|-----|
| 상품명 | `[Cuggu] AI 크레딧 1회 - AI 사진 생성` |
| 판매가 | **1,000원** |
| **판매자 상품코드** | **`AI_CREDITS`** |
| 카테고리 | 디지털/가전 > 소프트웨어 > 유틸리티 |
| 재고 | 99999 |
| 배송 | **배송 없음** |

#### 상품 3: AI 크레딧 10회 패키지

| 항목 | 값 |
|------|-----|
| 상품명 | `[Cuggu] AI 크레딧 10회 패키지 - AI 사진 생성 (20% 할인)` |
| 판매가 | **8,000원** |
| **판매자 상품코드** | **`AI_CREDITS_BUNDLE`** |
| 카테고리 | 디지털/가전 > 소프트웨어 > 유틸리티 |
| 재고 | 99999 |
| 배송 | **배송 없음** |

### 판매자 상품코드 설정 방법

상품 등록 화면에서 **"판매자 상품코드"** (또는 "관리코드") 필드에 위 코드를 **정확히** 입력해야 함. 이 코드가 Commerce API의 `sellerProductCode`로 반환되어 Cuggu 서버에서 상품 타입을 식별하는 데 사용됨.

```
판매자 상품코드  →  Commerce API sellerProductCode  →  Cuggu PaymentType
PREMIUM_UPGRADE  →  PREMIUM_UPGRADE                 →  프리미엄 업그레이드
AI_CREDITS       →  AI_CREDITS                      →  AI 크레딧 1회
AI_CREDITS_BUNDLE → AI_CREDITS_BUNDLE               →  AI 크레딧 10회
```

> **중요**: 코드가 정확히 일치하지 않으면 활성화 시 "알 수 없는 상품코드" 에러 발생. 대소문자, 언더스코어 주의.

### 상품 상세 설명에 포함할 내용

각 상품 상세페이지에 아래 안내 문구를 반드시 포함:

```
📌 구매 후 활성화 방법
1. cuggu.com/activate 에 접속합니다.
2. 카카오 또는 네이버로 로그인합니다.
3. 주문내역에서 "상품주문번호"를 확인하여 입력합니다.
4. 크레딧/프리미엄이 즉시 지급됩니다.

※ 상품주문번호는 네이버 > 내 쇼핑 > 주문/배송에서 확인할 수 있습니다.
※ 디지털 상품으로 별도 배송이 없습니다.
※ 문의: help@cuggu.com
```

---

## 5단계: Commerce API 애플리케이션 등록

### 커머스API 센터 가입

1. [네이버 커머스API 센터](https://apicenter.commerce.naver.com) 접속
2. 스마트스토어 계정으로 로그인
3. **커머스 API 계정 생성** 진행

### 애플리케이션 등록

1. **내 애플리케이션** → **애플리케이션 등록하기** 클릭
2. 애플리케이션 정보 입력:

| 항목 | 입력값 |
|------|--------|
| 애플리케이션 이름 | `Cuggu 결제 연동` |
| 설명 | `스마트스토어 주문 확인 및 발송 처리 자동화` |

3. **API 그룹 추가** — 아래 항목 선택:
   - **주문 판매자** (필수 — 주문 조회 + 발송 처리)
   - 상품 (선택 — 나중에 상품 자동 관리 시 필요)
   - 판매자정보 (선택)

4. **등록** 버튼 클릭

### 인증 정보 확인

등록 완료 후 확인할 수 있는 값 2개:

| 항목 | 설명 | 예시 |
|------|------|------|
| **애플리케이션 ID** | = `NAVER_COMMERCE_CLIENT_ID` | `1zRHxKB9sMaK0o0o0o` |
| **애플리케이션 시크릿** | = `NAVER_COMMERCE_CLIENT_SECRET` (bcrypt salt 형식) | `$2a$04$XXXX...` |

> **보안**: 시크릿은 bcrypt salt 형식(`$2a$...`)으로 발급됨. 이 값이 `.env`의 `NAVER_COMMERCE_CLIENT_SECRET`에 들어감. 절대 외부에 노출하지 말 것.

### API 호출 IP 등록

Commerce API는 등록된 IP에서만 호출 가능 (최대 3개):

1. 내 애플리케이션 → **API 호출 IP 관리**
2. Vercel 배포 환경의 경우:
   - Vercel은 고정 IP가 없으므로, Vercel에서 outbound IP를 제공하는 경우 해당 IP 등록
   - 또는 프록시 서버를 통해 고정 IP 사용
   - **개발/테스트 시**: 현재 개발 환경의 공인 IP 등록

> **참고**: IP 제한이 문제가 되면 Vercel의 [Static IP](https://vercel.com/docs/security/secure-compute) 기능 또는 별도 프록시 사용을 검토.

---

## 6단계: 환경 변수 설정

### `.env.local`에 추가

```bash
# Naver Commerce API (스마트스토어)
NAVER_COMMERCE_CLIENT_ID="발급받은_애플리케이션_ID"
NAVER_COMMERCE_CLIENT_SECRET="$2a$04$발급받은_시크릿..."
```

### Vercel 환경 변수

```bash
vercel env add NAVER_COMMERCE_CLIENT_ID
vercel env add NAVER_COMMERCE_CLIENT_SECRET
```

> `CLIENT_SECRET` 값에 `$` 문자가 포함되어 있으므로, Vercel 대시보드에서 직접 입력하는 것을 권장. CLI로 입력 시 쉘 이스케이프 주의.

---

## 7단계: 테스트

### 로컬 테스트 (Commerce API 연동 전)

API 없이 페이지 동작만 확인:

1. `npm run dev` 실행
2. `/activate` 접속 → 미로그인 시 로그인 버튼 표시 확인
3. 로그인 후 → 주문번호 입력 폼 표시 확인
4. 임의 번호 입력 → Commerce API 에러 응답 확인 (정상)

### E2E 테스트 (Commerce API 연동 후)

1. **테스트 주문 생성**: 스마트스토어에서 본인이 직접 테스트 구매 (네이버페이)
2. **상품주문번호 확인**: 네이버 > 내 쇼핑 > 주문/배송 > 상품주문번호 복사
3. **활성화 테스트**:
   - `/activate` 접속 → 로그인 → 상품주문번호 입력 → "활성화하기"
   - 성공 화면 확인: 크레딧 지급 + 대시보드 링크
4. **중복 활성화 테스트**: 같은 주문번호로 다시 시도 → "이미 활성화된 주문입니다" (409)
5. **Rate limit 테스트**: 6회 연속 시도 → "요청이 너무 많습니다" (429)
6. **결제 내역 확인**: 대시보드 설정 > 결제 내역에서 "스마트스토어" 뱃지 표시
7. **어드민 확인**: 어드민 패널 > 결제 관리에서 "네이버페이" 라벨 표시

### 발송 처리 확인

활성화 성공 후 스마트스토어 판매자센터에서:
- **발주/발송 관리** → 해당 주문이 "발송완료"로 변경되었는지 확인

---

## 체크리스트

```
[ ] 사업자등록증 발급
[ ] 통신판매업 신고 완료 (번호 발급)
[ ] 스마트스토어 셀러 가입 + 심사 승인
[ ] 상품 3개 등록
    [ ] PREMIUM_UPGRADE (9,900원)
    [ ] AI_CREDITS (1,000원)
    [ ] AI_CREDITS_BUNDLE (8,000원)
    [ ] 판매자 상품코드 정확히 입력
    [ ] 상세 설명에 활성화 안내 문구 포함
[ ] Commerce API 센터 가입
    [ ] 애플리케이션 등록
    [ ] 주문 판매자 API 그룹 추가
    [ ] API 호출 IP 등록
[ ] 환경 변수 설정
    [ ] .env.local (로컬)
    [ ] Vercel 환경 변수 (프로덕션)
[ ] DB 마이그레이션 실행 (0013_smartstore_payment.sql)
[ ] E2E 테스트 완료
    [ ] 테스트 구매 → 활성화 → 크레딧 확인
    [ ] 중복 활성화 → 409
    [ ] 발송 처리 → 판매자센터 확인
```

---

## 비용 구조

| 항목 | 비용 |
|------|------|
| 스마트스토어 입점 수수료 | 없음 (무료) |
| 네이버페이 결제 수수료 | **3.74%** (일반 결제) |
| 매출 연동 수수료 | **2%** (네이버 검색 유입) / 없음 (직접 유입) |
| Commerce API | 무료 |

> 예시: 9,900원 프리미엄 판매 시 수수료 약 370~570원 → 실수령 약 9,330~9,530원

---

## 주의사항

1. **판매자 상품코드**: 반드시 `PREMIUM_UPGRADE`, `AI_CREDITS`, `AI_CREDITS_BUNDLE` 정확히 입력. 오타 시 활성화 불가.
2. **IP 등록**: Commerce API는 등록된 IP에서만 호출 가능. Vercel 배포 시 IP 고정 방안 필요.
3. **시크릿 보안**: `NAVER_COMMERCE_CLIENT_SECRET`은 bcrypt salt로, 노출 시 즉시 재발급.
4. **테스트 구매**: 본인 스토어에서 본인 구매 가능 (테스트 후 취소/환불 처리).
5. **디지털 상품 배송**: "배송 없음"으로 설정하지 않으면 구매자가 배송 추적을 기대하게 됨.
